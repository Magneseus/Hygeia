<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Hygiea</title>
    
    <style type="text/css">
		* {
			box-sizing: border-box;
		}
		html, body {
			padding: 0;
			margin: 0;
			width: 100%;
			height: 100%;
			overflow: hidden;
		}
		canvas {
			margin: 0;
			padding: 0;
		}
	</style>
    
    <script type="text/javascript" src="timeout.js"></script>
    <script type="text/javascript" src="engine.js"></script>
    <script type="text/javascript">
		let canvas;
		let context;
		let simulation;
        let simTickRate = 0;
        let mouseDrawing = false;
        let mouseCoords = {x: 0, y: 0};
        let startSeed = 1;
        const map = `. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . . . . . 1 . . . . . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . . . . . 1 . . . . . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . . . . . 1 . . . . . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . . . . . 1 . . . . . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . . . . . 1 . . . . . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . . . . . 1 . . . . . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . . . . . 1 . . . . . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . . . . . 1 . . . . . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . . . . . 1 . . . . . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . . . . . 3 . . . . . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . . . . 3 . 3 . . . . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . . . 3 . 3 . 3 . . . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . . 3 . 3 . 3 . 3 . . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . 3 . 3 . 3 . 3 . 3 . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . 3 . 3 . 3 . 3 . 3 . 3 . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . 3 . 3 . 3 . 3 . 3 . 3 . 3 . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . . . . . . . . . .
. . . . . . . . . . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . . . . . . . . . .
. . . . . . . . . . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . . . . . . . . . .
. . . . . . . . . . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . . . . . . . . . .
. . . . . . . . . . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . . . . . . . . . .
. . . . . . . . . . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . . . . . . . . . .
. . . . . . . . . . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . . . . . . . . . .
. . . . . . . . . . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . . . . . . . . . .
. . . . . . . . . . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . 3 . . . . . . . . . .`;
        
		window.addEventListener("load", function() {
			canvas = document.getElementById('mainCanvas');
			context = canvas.getContext("2d");
            
            // Initialize engine
			simulation = new Engine(canvas, context);
            
            // Setup mouse movement
            canvas.addEventListener('mousedown', e => {
                mouseDrawing = true;
                mouseCoords = getMousePos(canvas, e);
            });
            canvas.addEventListener('mousemove', e=> {
                mouseCoords = getMousePos(canvas, e);
            });
            canvas.addEventListener('mouseup', e => {
                mouseDrawing = false;
            });
            canvas.addEventListener('mouseout', e => {
                mouseDrawing = false;
            });
            document.addEventListener('keydown', e=> {
                simulation.onKeyboardDown(e);
            });
            
            // Start render tick
            requestAnimationFrame(renderTick);
            
            // Start sim tick
            if (simTickRate >= 10) {
                window.setInterval(simTick, simTickRate);
            } else {
                window.setZeroTimeout(simTick);
            }
		});
        
        function simTick() {
            //simulation.renderTick(canvas, context);
            
            if (mouseDrawing) simulation.onMouseDown(mouseCoords);
            
            let simChanged = simulation.simTick();
            if (!simChanged) {
                let grains = simulation.sandList;
                let output = grains.reduce((acc, cur) => {
                    if (cur.type === 'sand') {
                        let idx = cur.pos.x.toString();
                        idx -= 1;
                        idx /= 2;
                        idx -= 5;
                        if (Object.keys(acc).includes(idx)) {
                            acc[idx] += 1;
                        } else {
                            acc[idx] = 1;
                        }
                    }
                    
                    return acc;
                },
                {});
                
                if (startSeed % 100 == 0) { console.log('Seed { ' + startSeed + ' } completed simulation. ' + JSON.stringify(output)); }
                
                startSeed += 1;
                randGen.setSeed(startSeed);
                simulation.reset(new MapLoader(map));
            }
            
            if (simTickRate < 10) {
                window.setZeroTimeout(simTick);
            }
        }
        
        function renderTick() {
            //simTick();
            simulation.renderTick(canvas, context);
            requestAnimationFrame(renderTick);
        }
        
        // https://stackoverflow.com/questions/17130395/real-mouse-position-in-canvas
        function  getMousePos(canvas, evt) {
            let rect = canvas.getBoundingClientRect(); // abs. size of element
            let scaleX = canvas.width / rect.width;    // relationship bitmap vs. element for X
            let scaleY = canvas.height / rect.height;  // relationship bitmap vs. element for Y

            return {
                x: (evt.clientX - rect.left) * scaleX,   // scale mouse coordinates after they have
                y: (evt.clientY - rect.top) * scaleY     // been adjusted to be relative to element
            }
        }
        
    </script>
</head>
<body>
    <canvas id="mainCanvas" onmousedown="" width="1200" height="600"></canvas>
</body>
</html>
